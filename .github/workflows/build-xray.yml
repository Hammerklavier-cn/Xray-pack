name: Build Xray/v2ray @v1

on:
  workflow_dispatch:
    inputs:
      xray_version:
        description: "Xray-core/v2ray-core version (tag or branch, e.g., v1.8.0 or main)"
        required: false
        default: "main"
        type: string
      core_type:
        description: "Core type to build"
        required: false
        default: "xray"
        type: choice
        options:
          - xray
          - v2ray
      region:
        description: "Region for geo files"
        required: false
        default: "china-mainland"
        type: choice
        options:
          - china-mainland
          - russia
          - iran
      create_release:
        description: "Create a GitHub release with the artifacts"
        required: false
        default: false
        type: boolean
      release_tag:
        description: "Release tag (optional, auto-generated if empty: <CORE_TYPE>-latest-<REGION>)"
        required: false
        default: ""
        type: string
  push:
    branches:
      - gh-workflow

env:
  CARGO_TERM_COLOR: always
  CGO_ENABLED: 0
  CORE_TYPE: ${{ inputs.core_type || 'xray' }}
  GOEXPERIMENT: "jsonv2,greenteagc,newinliner"

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare xray-pack
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      artifact-name: ${{ steps.upload-artifact.outputs.artifact-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build xray-pack
        run: |
          echo "::group::Building xray-pack"
          cargo build --release --verbose
          echo "::endgroup::"

          echo "::group::Verify binary"
          ls -lh target/release/xray-pack
          file target/release/xray-pack
          echo "::endgroup::"

      - name: Upload xray-pack binary
        id: upload-artifact
        uses: actions/upload-artifact@v6
        with:
          name: xray-pack-binary
          path: target/release/xray-pack
          retention-days: 1
          if-no-files-found: error

  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goamd64 && '-' }}${{ matrix.goamd64 }}${{ matrix.goarm && '-v' }}${{ matrix.goarm }}${{ matrix.goarm64 && '-' }}${{ matrix.goarm64 }}${{ matrix.goriscv64 && '-' }}${{ matrix.goriscv64 }}
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 45
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        include:
          # Linux AMD64 with GOAMD64 levels
          - goos: linux
            goarch: amd64
            goamd64: v2
          - goos: linux
            goarch: amd64
            goamd64: v3
          - goos: linux
            goarch: amd64
            goamd64: v4

          # Linux ARM64
          - goos: linux
            goarch: arm64
            goarm64: v8.0
          - goos: linux
            goarch: arm64
            goarm64: v8.2
          - goos: linux
            goarch: arm64
            goarm64: v9.0

          # Linux ARM with GOARM versions
          - goos: linux
            goarch: arm
            goarm: 5
          - goos: linux
            goarch: arm
            goarm: 6
          - goos: linux
            goarch: arm
            goarm: 7

          # Linux RISC-V64
          - goos: linux
            goarch: riscv64
            goriscv64: rva20u64
          - goos: linux
            goarch: riscv64
            goriscv64: rva22u64

          # macOS AMD64 with GOAMD64 levels
          - goos: darwin
            goarch: amd64
            goamd64: v2
          - goos: darwin
            goarch: amd64
            goamd64: v3

          # macOS ARM64
          - goos: darwin
            goarch: arm64
            goarm64: v8.0
          - goos: darwin
            goarch: arm64
            goarm64: v8.5

          # Windows AMD64 with GOAMD64 levels
          - goos: windows
            goarch: amd64
            goamd64: v2
          - goos: windows
            goarch: amd64
            goamd64: v3
          - goos: windows
            goarch: amd64
            goamd64: v4

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache: true
          cache-dependency-path: |
            **/go.sum
            **/go.mod

      - name: Download xray-pack binary
        uses: actions/download-artifact@v7
        with:
          name: xray-pack-binary
          path: target/release

      - name: Make xray-pack executable
        run: |
          chmod +x target/release/xray-pack
          ./target/release/xray-pack --version || echo "Version check skipped"

      - name: Build ${{ env.CORE_TYPE }}-core
        shell: bash
        env:
          XRAY_PACK_VERSION: ${{ inputs.xray_version || 'main' }}
          REGION: ${{ inputs.region || 'china-mainland' }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOAMD64: ${{ matrix.goamd64 }}
          GOARM: ${{ matrix.goarm }}
          GOARM64: ${{ matrix.goarm64 }}
          GORISCV64: ${{ matrix.goriscv64 }}
        run: |
          set -euo pipefail

          echo "::group::Build Configuration"
          echo "Building ${{ env.CORE_TYPE }}-core version: $XRAY_PACK_VERSION"
          echo "Platform: $GOOS-$GOARCH"
          [[ -n "$GOAMD64" ]] && echo "GOAMD64: $GOAMD64"
          [[ -n "$GOARM" ]] && echo "GOARM: $GOARM"
          [[ -n "$GOARM64" ]] && echo "GOARM64: $GOARM64"
          [[ -n "$GORISCV64" ]] && echo "GORISCV64: $GORISCV64"
          echo "Region: $REGION"
          echo "GOEXPERIMENT: $GOEXPERIMENT"
          echo "::endgroup::"

          echo "::group::Go Environment"
          go version
          go env | grep -E "GOOS|GOARCH|GOROOT|GOPATH|GOCACHE"
          echo "::endgroup::"

          VERSION_FLAG="--${{ env.CORE_TYPE }}-version"
          PACK_BINARY="./target/release/xray-pack"

          # Build command with all environment variables
          export GOEXPERIMENT
          [[ -n "$GOAMD64" ]] && export GOAMD64
          [[ -n "$GOARM" ]] && export GOARM
          [[ -n "$GOARM64" ]] && export GOARM64
          [[ -n "$GORISCV64" ]] && export GORISCV64

          echo "::group::Building ${{ env.CORE_TYPE }}-core"
          "$PACK_BINARY" \
            -s \
            -v \
            --goos "$GOOS" \
            --goarch "$GOARCH" \
            --region "$REGION" \
            ${{ env.CORE_TYPE }} \
            "$VERSION_FLAG"="$XRAY_PACK_VERSION"
          echo "::endgroup::"

      - name: Find and prepare artifacts
        shell: bash
        if: success()
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOAMD64: ${{ matrix.goamd64 }}
          GOARM: ${{ matrix.goarm }}
          GOARM64: ${{ matrix.goarm64 }}
          GORISCV64: ${{ matrix.goriscv64 }}
        run: |
          set -euo pipefail

          if [[ "$GOOS" == "windows" ]]; then
            BINARY_NAME="${{ env.CORE_TYPE }}.exe"
          else
            BINARY_NAME="${{ env.CORE_TYPE }}"
          fi

          # Build artifact name suffix
          SUFFIX="${GOARCH}-${GOOS}"
          if [[ -n "$GOAMD64" ]]; then
            SUFFIX="amd64-${GOAMD64}-${GOOS}"
          elif [[ -n "$GOARM" ]]; then
            SUFFIX="arm-v${GOARM}-${GOOS}"
          elif [[ -n "$GOARM64" ]]; then
            SUFFIX="arm64-${GOARM64//,/-}-${GOOS}"
          elif [[ -n "$GORISCV64" ]]; then
            SUFFIX="riscv64-${GORISCV64}-${GOOS}"
          fi

          # Build expected artifact name
          VERSION="${{ inputs.xray_version || 'main' }}"
          EXPECTED_ARTIFACT_NAME="${{ env.CORE_TYPE }}-${VERSION}-${SUFFIX}.zip"

          echo "Expected artifact name: $EXPECTED_ARTIFACT_NAME"

          # Find and rename the artifact
          FOUND=false
          for file in dist/*.zip; do
            if [[ -f "$file" ]]; then
              ARTIFACT_NAME=$(basename "$file")
              echo "Found artifact: $ARTIFACT_NAME"

              # Rename the artifact to include the correct suffix
              if [[ "$ARTIFACT_NAME" != "$EXPECTED_ARTIFACT_NAME" ]]; then
                NEW_PATH="dist/$EXPECTED_ARTIFACT_NAME"
                echo "Renaming to: $EXPECTED_ARTIFACT_NAME"
                mv "$file" "$NEW_PATH"
                ARTIFACT_NAME="$EXPECTED_ARTIFACT_NAME"
                file="$NEW_PATH"
              fi

              echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
              echo "ARTIFACT_PATH=$file" >> $GITHUB_ENV
              FOUND=true
              break
            fi
          done

          if [[ "$FOUND" == "false" ]]; then
            echo "::error::No artifact found in dist/"
            ls -la dist/ || echo "dist/ directory not found"
            exit 1
          fi

          echo "Final artifact: $ARTIFACT_NAME at $file"
          ls -lh "$file"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        if: success()
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30
          if-no-files-found: error
          compression-level: 0

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: inputs.create_release == true
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: "${{ env.CORE_TYPE }}-*"

      - name: Display structure of downloaded files
        run: |
          echo "::group::Artifact Structure"
          ls -R artifacts
          echo "::endgroup::"

      - name: Prepare release files
        run: |
          mkdir -p release-files
          # Copy only zip files to release directory, excluding xray-pack binary
          find artifacts -name "*.zip" -type f -exec cp {} release-files/ \;

          if [ -z "$(ls -A release-files/)" ]; then
            echo "::error::No zip files found in artifacts"
            exit 1
          fi

          echo "::group::Files to be released"
          ls -lh release-files/
          echo "::endgroup::"

      - name: Generate checksums
        run: |
          cd release-files
          sha256sum *.zip > SHA256SUMS
          echo "::group::SHA256 Checksums"
          cat SHA256SUMS
          echo "::endgroup::"

      - name: Determine release tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if user provided a custom release_tag
          if [ -n "${{ inputs.release_tag }}" ]; then
            TAG_NAME="${{ inputs.release_tag }}"
            echo "Using user-provided tag: $TAG_NAME"
          else
            TAG_NAME="${{ env.CORE_TYPE }}-latest-${{ inputs.region }}"
            echo "Using auto-generated tag: $TAG_NAME"
          fi

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Release tag: $TAG_NAME"

      - name: Create or update tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current commit SHA
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_SHA"

          # Create or update the tag (use --force to update if it exists)
          git tag -f "${{ env.TAG_NAME }}" "$CURRENT_SHA"
          git push origin "${{ env.TAG_NAME }}" --force

          echo "Tag ${{ env.TAG_NAME }} created/updated at commit $CURRENT_SHA"

      - name: Delete existing release if it exists
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if release exists for tag: ${{ env.TAG_NAME }}"
          if gh release view "${{ env.TAG_NAME }}" > /dev/null 2>&1; then
            echo "Release exists, deleting..."
            gh release delete "${{ env.TAG_NAME }}" --yes --cleanup-tag
            echo "Waiting for deletion to complete..."
            sleep 10
          else
            echo "Release does not exist, proceeding..."
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.CORE_TYPE }}-core Bundle - ${{ env.TAG_NAME }} (Pre-release)
          files: |
            release-files/*.zip
            release-files/SHA256SUMS
          generate_release_notes: true
          draft: false
          prerelease: true
          fail_on_unmatched_files: true
          make_latest: false
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ## ðŸŽ‰ ${{ env.CORE_TYPE }}-core ${{ inputs.xray_version }} Bundle

            **âš ï¸ æ³¨æ„: è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)**
            **âš ï¸ Note: This is a pre-release**

            è¿™æ˜¯ä½¿ç”¨ xray-pack æ‰“åŒ…çš„ ${{ env.CORE_TYPE }}-core é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ**ä¸æ˜¯ xray-pack ç¨‹åºæœ¬èº«çš„å‘å¸ƒ**ã€‚
            This is a pre-packaged ${{ env.CORE_TYPE }}-core binary bundle using xray-pack, **not the xray-pack program itself**.

            ### ðŸ“¦ ä¸‹è½½ / Downloads

            è¿™æ˜¯æ‰‹åŠ¨è§¦å‘çš„æž„å»ºç‰ˆæœ¬ã€‚
            This is a manually triggered build.

            **ç‰ˆæœ¬ / Version**: ${{ inputs.xray_version }}
            **åœ°åŒº / Region**: ${{ inputs.region }}
            **GOEXPERIMENT**: ${{ env.GOEXPERIMENT }}

            #### ðŸ“‹ æ–‡ä»¶æ ¡éªŒ / File Verification
            ä¸‹è½½åŽè¯·ä½¿ç”¨ `SHA256SUMS` æ–‡ä»¶éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
            ```bash
            sha256sum -c SHA256SUMS
            ```

            | OS | Architecture | CPU Features | Download |
            |---|---|---|---|
            | Linux | amd64-v2 | SSE4.2, POPCNT | ${{ env.CORE_TYPE }}-*-amd64-v2-linux.zip |
            | Linux | amd64-v3 | AVX, AVX2 | ${{ env.CORE_TYPE }}-*-amd64-v3-linux.zip |
            | Linux | amd64-v4 | AVX512 | ${{ env.CORE_TYPE }}-*-amd64-v4-linux.zip |
            | Linux | arm64-v8.0 | ARMv8.0-A | ${{ env.CORE_TYPE }}-*-arm64-v8.0-linux.zip |
            | Linux | arm64-v8.2 | ARMv8.2-A, LSE | ${{ env.CORE_TYPE }}-*-arm64-v8.2-linux.zip |
            | Linux | arm64-v9.0 | ARMv9.0-A, SVE2 | ${{ env.CORE_TYPE }}-*-arm64-v9.0-linux.zip |
            | Linux | arm-v5 | ARMv5 | ${{ env.CORE_TYPE }}-*-arm-v5-linux.zip |
            | Linux | arm-v6 | ARMv6, VFPv1 | ${{ env.CORE_TYPE }}-*-arm-v6-linux.zip |
            | Linux | arm-v7 | ARMv7, VFPv3 | ${{ env.CORE_TYPE }}-*-arm-v7-linux.zip |
            | Linux | riscv64-rva20u64 | RVA20U64 (RV64GC) | ${{ env.CORE_TYPE }}-*-riscv64-rva20u64-linux.zip |
            | Linux | riscv64-rva22u64 | RVA22U64 | ${{ env.CORE_TYPE }}-*-riscv64-rva22u64-linux.zip |
            | macOS (Intel) | amd64-v2 | SSE4.2, POPCNT | ${{ env.CORE_TYPE }}-*-amd64-v2-darwin.zip |
            | macOS (Intel) | amd64-v3 | AVX, AVX2 | ${{ env.CORE_TYPE }}-*-amd64-v3-darwin.zip |
            | macOS (Apple Silicon) | arm64-v8.0 | ARMv8.0-A | ${{ env.CORE_TYPE }}-*-arm64-v8.0-darwin.zip |
            | macOS (Apple Silicon) | arm64-v8.5 | ARMv8.5-A | ${{ env.CORE_TYPE }}-*-arm64-v8.5-darwin.zip |
            | Windows | amd64-v2 | SSE4.2, POPCNT | ${{ env.CORE_TYPE }}-*-amd64-v2-windows.zip |
            | Windows | amd64-v3 | AVX, AVX2 | ${{ env.CORE_TYPE }}-*-amd64-v3-windows.zip |
            | Windows | amd64-v4 | AVX512 | ${{ env.CORE_TYPE }}-*-amd64-v4-windows.zip |

            ### ðŸ“ åŒ…å«å†…å®¹ / Contents

            æœ¬å‘å¸ƒåŒ…ä½¿ç”¨ [xray-pack](https://github.com/${{ github.repository }}) å·¥å…·æ‰“åŒ…ã€‚
            This release is bundled using [xray-pack](https://github.com/${{ github.repository }}) tool.

            - ${{ env.CORE_TYPE }}-core äºŒè¿›åˆ¶æ–‡ä»¶ / binary
            - geoip.dat å’Œ geosite.dat (åœ°åŒº: ${{ inputs.region }})
            - README.md å’Œ LICENSE
            - (Windows å’Œ Xray) wintun.dll å’Œ LICENSE-wintun.txt

            ðŸ’¡ å¦‚éœ€èŽ·å– xray-pack ç¨‹åºæœ¬èº«ï¼Œè¯·å‰å¾€ [xray-pack Releases](https://github.com/${{ github.repository }}/releases)
            ðŸ’¡ To get the xray-pack program itself, please visit [xray-pack Releases](https://github.com/${{ github.repository }}/releases)

            ### âš™ï¸ æž„å»ºå‚æ•° / Build Parameters

            - Core ç±»åž‹: ${{ env.CORE_TYPE }}
            - ç‰ˆæœ¬: ${{ inputs.xray_version }}
            - åœ°åŒº: ${{ inputs.region }}
            - GOEXPERIMENT: ${{ env.GOEXPERIMENT }}
            - è§¦å‘æ—¶é—´: ${{ github.event.head_commit.timestamp }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Completion
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        id: check_status
        run: |
          BUILD_STATUS="${{ needs.build.result }}"
          RELEASE_STATUS="${{ needs.release.result }}"

          echo "BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_ENV
          echo "RELEASE_STATUS=$RELEASE_STATUS" >> $GITHUB_ENV

          if [[ "$BUILD_STATUS" == "success" ]]; then
            echo "BUILD_EMOJI=âœ…" >> $GITHUB_ENV
          else
            echo "BUILD_EMOJI=âŒ" >> $GITHUB_ENV
          fi

          if [[ "$RELEASE_STATUS" == "success" ]]; then
            echo "RELEASE_EMOJI=âœ…" >> $GITHUB_ENV
          elif [[ "$RELEASE_STATUS" == "skipped" ]]; then
            echo "RELEASE_EMOJI=â­ï¸" >> $GITHUB_ENV
          else
            echo "RELEASE_EMOJI=âŒ" >> $GITHUB_ENV
          fi

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ æž„å»ºå®Œæˆ / Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºçŠ¶æ€ / Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»º / Build**: ${{ env.BUILD_EMOJI }} \`${{ env.BUILD_STATUS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒ / Release**: ${{ env.RELEASE_EMOJI }} \`${{ env.RELEASE_STATUS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºä¿¡æ¯ / Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Core ç±»åž‹**: \`${{ env.CORE_TYPE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: \`${{ inputs.xray_version || 'main' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åœ°åŒº**: \`${{ inputs.region || 'china-mainland' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GOEXPERIMENT**: \`${{ env.GOEXPERIMENT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ—¶é—´**: \`${{ github.event.head_commit.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š CPU ä¼˜åŒ–è¯´æ˜Ž / CPU Optimization Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AMD64 (x86_64) æž¶æž„**:" >> $GITHUB_STEP_SUMMARY
          echo "- **v2**: é€‚ç”¨äºŽæ”¯æŒ SSE4.2 å’Œ POPCNT æŒ‡ä»¤çš„ CPUï¼ˆ2010å¹´åŠä»¥åŽçš„ Intel/AMD CPUï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **v3**: é€‚ç”¨äºŽæ”¯æŒ AVX å’Œ AVX2 æŒ‡ä»¤çš„ CPUï¼ˆ2015å¹´åŠä»¥åŽçš„ Intel Haswellï¼ŒAMD Ryzenï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **v4**: é€‚ç”¨äºŽæ”¯æŒ AVX512 æŒ‡ä»¤çš„ CPUï¼ˆ2017å¹´åŠä»¥åŽçš„ Intel Skylake-Xï¼Œéƒ¨åˆ† AMD EPYCï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ARM (32ä½) æž¶æž„**:" >> $GITHUB_STEP_SUMMARY
          echo "- **v5**: é€‚ç”¨äºŽ ARMv5 å¤„ç†å™¨ï¼ˆè½¯æµ®ç‚¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **v6**: é€‚ç”¨äºŽ ARMv6 å¤„ç†å™¨ï¼ˆVFPv1 ç¡¬ä»¶æµ®ç‚¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **v7**: é€‚ç”¨äºŽ ARMv7 å¤„ç†å™¨ï¼ˆVFPv3ï¼Œå¸¸è§äºŽå¤§å¤šæ•° ARM è®¾å¤‡ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [æŸ¥çœ‹è¿è¡Œè¯¦æƒ… / View Run Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
