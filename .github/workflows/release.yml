name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_arch: x86_64
            os_name: linux
            arch_name: amd64
            libc: gnu
            use_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            rust_arch: x86_64
            os_name: linux
            arch_name: amd64
            libc: musl
            use_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            rust_arch: aarch64
            os_name: linux
            arch_name: arm64
            libc: gnu
            use_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            rust_arch: aarch64
            os_name: linux
            arch_name: arm64
            libc: musl
            use_cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            rust_arch: armv7
            os_name: linux
            arch_name: arm
            libc: gnu
            use_cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-musleabihf
            rust_arch: armv7
            os_name: linux
            arch_name: arm
            libc: musl
            use_cross: true
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-gnu
            rust_arch: riscv64gc
            os_name: linux
            arch_name: riscv64
            libc: gnu
            use_cross: true

          # macOS
          - os: macos-latest
            target: aarch64-apple-darwin
            rust_arch: aarch64
            os_name: darwin
            arch_name: arm64
            libc: darwin
            use_cross: false

          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_arch: x86_64
            os_name: windows
            arch_name: amd64
            libc: msvc
            use_cross: false
          - os: ubuntu-latest
            target: x86_64-pc-windows-gnu
            rust_arch: x86_64
            os_name: windows
            arch_name: amd64
            libc: gnu
            use_cross: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@cross

      - name: Install Strawberry Perl (Windows only)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          # Download and install Strawberry Perl for Windows
          # This is required for building openssl-sys with vendored feature on Windows
          echo "Installing Strawberry Perl for Windows..."

          # Clean up old files and directories if they exist
          rm -f strawberry-perl.zip
          rm -rf C:/strawberry

          curl -L -o strawberry-perl.zip https://github.com/StrawberryPerl/Perl-Dist-Strawberry/releases/download/SP_54201_64bit/strawberry-perl-5.42.0.1-64bit-portable.zip
          7z x strawberry-perl.zip -o"C:/strawberry" -y

          # Add Strawberry Perl to PATH for current and subsequent steps
          # echo "C:/strawberry/perl/bin" >> $GITHUB_PATH
          # export PATH="C:/strawberry/perl/bin:$PATH"
          export PERL="C:/strawberry/perl/bin/perl.exe"

          # Verify the correct Perl is being used
          echo "Perl version:"
          $PERL --version | head -n 2

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.5
        with:
          version: "v0.8.1"

      - name: Build binary
        env:
          RUSTC_WRAPPER: sccache
        run: |
          # On Windows, verify Perl is available for openssl-sys vendored build
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Checking Perl installation..."
            export PERL="C:/strawberry/perl/bin/perl.exe"
            $PERL --version || echo "Perl not found in PATH"
          fi

          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Prepare artifacts
        shell: bash
        run: |
          # Determine binary extension and name
          if [[ "${{ matrix.os_name }}" == "windows" ]]; then
            BINARY="xray-pack.exe"
            EXE_EXT=".exe"
          else
            BINARY="xray-pack"
            EXE_EXT=""
          fi

          # Unified artifact name: always include libc suffix
          ARTIFACT_NAME="xray-pack-${{ matrix.os_name }}-${{ matrix.arch_name }}-${{ matrix.libc }}${EXE_EXT}"

          # Copy binary to artifact name
          cp target/${{ matrix.target }}/release/${BINARY} ${ARTIFACT_NAME}

          # Make it executable on Unix-like systems
          if [[ "${{ matrix.os_name }}" != "windows" ]]; then
            chmod +x ${ARTIFACT_NAME}
          fi

          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

      - name: Compress binary
        shell: bash
        run: |
          if [[ "${{ matrix.os_name }}" == "windows" ]]; then
            7z a -tzip "${{ env.ARTIFACT_NAME }}.zip" "${{ env.ARTIFACT_NAME }}"
          else
            tar -czf "${{ env.ARTIFACT_NAME }}.tar.gz" "${{ env.ARTIFACT_NAME }}"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.*

      - name: Show sccache stats
        run: sccache --show-stats

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          body: |
            ## ğŸ‰ xray-pack ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½ / Downloads

            è¯·æ ¹æ®ä½ çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
            Please select the binary file corresponding to your system:

            | OS | Architecture | LibC | Download |
            |---|---|---|---|
            | Linux | x86_64 | glibc | xray-pack-linux-amd64-gnu |
            | Linux | x86_64 | musl | xray-pack-linux-amd64-musl |
            | Linux | arm64 | glibc | xray-pack-linux-arm64-gnu |
            | Linux | arm64 | musl | xray-pack-linux-arm64-musl |
            | Linux | armv7 | glibc | xray-pack-linux-arm-gnu |
            | Linux | armv7 | musl | xray-pack-linux-arm-musl |
            | Linux | riscv64 | glibc | xray-pack-linux-riscv64-gnu |
            | Linux | riscv64 | musl | xray-pack-linux-riscv64-musl |
            | macOS (Apple Silicon) | arm64 | Darwin | xray-pack-darwin-arm64-darwin |
            | Windows | x86_64 | MSVC | xray-pack-windows-amd64-msvc.exe |
            | Windows | x86_64 | GNU | xray-pack-windows-amd64-gnu.exe |

            **æ³¨æ„**:
            - musl ç‰ˆæœ¬æ˜¯é™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯åœ¨ä»»ä½• Linux å‘è¡Œç‰ˆä¸Šç›´æ¥è¿è¡Œï¼Œæ— éœ€é¢å¤–ä¾èµ–ã€‚
            - Windows GNU ç‰ˆæœ¬ä½¿ç”¨ mingw å·¥å…·é“¾æ„å»ºï¼Œä¸ MSVC ç‰ˆæœ¬ç›¸æ¯”å¯èƒ½å…·æœ‰ä¸åŒçš„è¡Œä¸ºã€‚

            **Note**:
            - musl versions are statically linked binaries that can run on any Linux distribution without additional dependencies.
            - Windows GNU version is built using mingw toolchain and may have different behavior compared to MSVC version.

            ### ğŸ“ ä½¿ç”¨è¯´æ˜ / Usage

            è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚
            Please refer to [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for detailed usage instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Release Notification
        run: |
          echo "Release ${{ github.ref_name }} has been successfully created!"
          echo "Check it out at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
