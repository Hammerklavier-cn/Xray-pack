name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.rust_arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_arch: x86_64
            os_name: linux
            arch_name: amd64
            use_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            rust_arch: x86_64
            os_name: linux
            arch_name: amd64-musl
            use_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            rust_arch: aarch64
            os_name: linux
            arch_name: arm64
            use_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            rust_arch: aarch64
            os_name: linux
            arch_name: arm64-musl
            use_cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            rust_arch: armv7
            os_name: linux
            arch_name: arm
            use_cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-musleabihf
            rust_arch: armv7
            os_name: linux
            arch_name: arm-musl
            use_cross: true
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-gnu
            rust_arch: riscv64gc
            os_name: linux
            arch_name: riscv64
            use_cross: true

          # macOS
          - os: macos-latest
            target: aarch64-apple-darwin
            rust_arch: aarch64
            os_name: darwin
            arch_name: arm64
            use_cross: false

          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_arch: x86_64
            os_name: windows
            arch_name: amd64
            use_cross: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@cross

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.5
        with:
          version: "v0.8.1"

      - name: Build binary
        env:
          RUSTC_WRAPPER: sccache
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Prepare artifacts
        shell: bash
        run: |
          # Determine binary extension and name
          if [[ "${{ matrix.os_name }}" == "windows" ]]; then
            BINARY="Xray-pack.exe"
            EXE_EXT=".exe"
          else
            BINARY="Xray-pack"
            EXE_EXT=""
          fi

          # Determine artifact name
          ARTIFACT_NAME="Xray-pack-${{ matrix.os_name }}-${{ matrix.arch_name }}${EXE_EXT}"

          # Copy binary to artifact name
          cp target/${{ matrix.target }}/release/${BINARY} ${ARTIFACT_NAME}

          # Make it executable on Unix-like systems
          if [[ "${{ matrix.os_name }}" != "windows" ]]; then
            chmod +x ${ARTIFACT_NAME}
          fi

          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

      - name: Compress binary
        shell: bash
        run: |
          cd ${{ github.workspace }}
          if [[ "${{ matrix.os_name }}" == "windows" ]]; then
            7z a -tzip "${{ env.ARTIFACT_NAME }}.zip" "${{ env.ARTIFACT_NAME }}"
          else
            tar -czf "${{ env.ARTIFACT_NAME }}.tar.gz" "${{ env.ARTIFACT_NAME }}"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.*

      - name: Show sccache stats
        run: sccache --show-stats

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          body: |
            ## ğŸ‰ Xray-pack ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½ / Downloads

            è¯·æ ¹æ®ä½ çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
            Please select the binary file corresponding to your system:

            | OS | Architecture | Download |
            |---|---|---|
            | Linux | x86_64 (glibc) | Xray-pack-linux-amd64 |
            | Linux | x86_64 (musl) | Xray-pack-linux-amd64-musl |
            | Linux | arm64 (glibc) | Xray-pack-linux-arm64 |
            | Linux | arm64 (musl) | Xray-pack-linux-arm64-musl |
            | Linux | armv7 (glibc) | Xray-pack-linux-arm |
            | Linux | armv7 (musl) | Xray-pack-linux-arm-musl |
            | Linux | riscv64 | Xray-pack-linux-riscv64 |
            | macOS (Apple Silicon) | arm64 | Xray-pack-darwin-arm64 |
            | Windows | x86_64 | Xray-pack-windows-amd64.exe |

            **æ³¨æ„**: musl ç‰ˆæœ¬æ˜¯é™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯åœ¨ä»»ä½• Linux å‘è¡Œç‰ˆä¸Šç›´æ¥è¿è¡Œï¼Œæ— éœ€é¢å¤–ä¾èµ–ã€‚
            **Note**: musl versions are statically linked binaries that can run on any Linux distribution without additional dependencies.

            ### ğŸ“ ä½¿ç”¨è¯´æ˜ / Usage

            è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚
            Please refer to [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for detailed usage instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Release Notification
        run: |
          echo "Release ${{ github.ref_name }} has been successfully created!"
          echo "Check it out at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
